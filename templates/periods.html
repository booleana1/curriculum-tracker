{% extends "base.html" %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-2">
    <h3 class="m-0">Disciplinas por período recomendado</h3>

    <div class="d-flex align-items-center gap-2">
        <!-- ênfase -->
        <form method="get" class="d-flex align-items-center gap-2">
            <label class="me-2 text-muted small">Ênfase</label>
            <select name="emphasis_id" class="form-select form-select-sm" onchange="this.form.submit()">
                {% for e in emphases %}
                <option value="{{ e.id }}" {% if selected_emphasis_id==e.id %}selected{% endif %}>{{ e.name }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="user_id" value="{{ user_id or '' }}">
        </form>

        <!-- user -->
        <form method="post" action="/user/set" class="d-flex align-items-center gap-1">
            <input type="hidden" name="emphasis_id" value="{{ selected_emphasis_id or '' }}">

            <input type="text" name="username" class="form-control form-control-sm py-0" placeholder="username"
                value="{{ username or '' }}" required style="width: 140px; flex: 0 0 140px;">

            <button class="btn btn-sm btn-primary px-2" type="submit">Abrir</button>

            {% if username %}
            <button class="btn btn-sm btn-success px-2" type="button" onclick="saveSelections()">
                Salvar
            </button>
            <a href="/user/logout" class="btn btn-sm btn-outline-secondary px-2">Trocar</a>
            {% endif %}
        </form>


    </div>
</div>




{% if periods|length == 0 %}
<div class="alert alert-warning">Nenhuma disciplina com <em>period_suggested</em> definido.</div>
{% endif %}

<div class="periods-grid" style="grid-template-columns: repeat({{ periods|length }}, 1fr);">
    {% for p in periods %}
    <div class="period-col" id="p{{p}}">
        <div class="period-title period-action" data-period="{{ p }}">{{ p }}º Período</div>
        {% for c in grouped[p] %}
        {% set st = status_map.get(c.course_id) %}
        <button type="button" class="course-btn
               {% if st == 'PLANEJADO' %}is-planned{% endif %}
               {% if st in ['CONCLUIDO','APROVEITADO'] %}is-done{% endif %}"
            style="border: 3px solid {{ color_for(c.nucleo_name) }};" data-course-id="{{ c.course_id }}"
            data-ch="{{ c.ch_total }}" data-status="{{ st or '' }}">
            <div>
                <span class="course-name">{{ c.course_name }}</span>
                <span class="course-ch">{{ c.ch_total }}h</span>
            </div>
        </button>
        {% endfor %}
    </div>
    {% endfor %}
</div>


<div class="row g-2 mb-2">
    <div class="col-auto">
        <span class="badge text-bg-success rounded-pill">CH Concluída: <span id="chDone">0</span>h</span>
    </div>
    <div class="col-auto">
        <span class="badge text-bg-dark rounded-pill">CH Pretendida: <span id="chPlanned">0</span>h</span>
    </div>
    <div class="col-auto">
        <span class="badge text-bg-primary rounded-pill">Projeção: <span id="chProjected">0</span>h</span>
    </div>
    <div class="col-auto">
        <span class="badge text-bg-warning rounded-pill">CH Restante: <span id="chRemaining">0</span>h</span>
    </div>
</div>

<div class="d-flex flex-wrap align-items-center gap-3 mb-3">
    <div class="d-flex align-items-center gap-1">
        <span class="legend-dot" style="background:#E0E0E0;"></span>
        <small>Básico</small>
    </div>
    <div class="d-flex align-items-center gap-1">
        <span class="legend-dot" style="background:#FFD2A6;"></span>
        <small>Instrumentação</small>
    </div>
    <div class="d-flex align-items-center gap-1">
        <span class="legend-dot" style="background:#B3D4FF;"></span>
        <small>Controle</small>
    </div>
    <div class="d-flex align-items-center gap-1">
        <span class="legend-dot" style="background:#BEEBC2;"></span>
        <small>Automação</small>
    </div>
    <div class="d-flex align-items-center gap-1">
        <span class="legend-dot" style="background:#CFCFCF;"></span>
        <small>Gestão e Normativas</small>
    </div>
</div>


<script>
    const USER_ID = {{ user_id or 'null' }};
    const TOTAL_CH = {{ total_ch_display or 0 }};
    const PR_MAP = {{ pr_map | tojson | safe }};
    const CO_FWD = {{ co_fwd | tojson | safe }};
    const CO_REV = {{ co_rev | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='main.js') }}"></script>


{% endblock %}
